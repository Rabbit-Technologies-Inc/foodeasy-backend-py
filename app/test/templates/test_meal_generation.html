<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Generation Testing UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 24px;
            color: #333;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"],
        input[type="number"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .card-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            min-height: 300px;
        }

        textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .preferences-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preferences-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
        }

        .preferences-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .preferences-body {
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .preference-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .preference-item:last-child {
            border-bottom: none;
        }

        .preference-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .preference-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .preference-value.empty {
            color: #999;
            font-style: italic;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-backdrop.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
            margin: auto;
        }

        .modal-large {
            max-width: 90%;
            width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
        }

        .modal-extra-large {
            max-width: 95%;
            width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            text-align: left;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        label .required {
            color: #e74c3c;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
            min-height: 120px;
        }

        select[multiple] {
            min-height: 150px;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            color: #333;
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result-container.show {
            display: block;
        }

        .result-container pre {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }

        .result-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .result-tab {
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .result-tab.active {
            background: #007bff;
            color: white;
        }

        .result-tab:hover {
            background: #dee2e6;
        }

        .result-tab.active:hover {
            background: #0056b3;
        }

        .result-view {
            display: none;
        }

        .result-view.active {
            display: block;
        }

        .meal-plan-structured {
            background: white;
            padding: 20px;
            border-radius: 4px;
        }

        .meal-plan-day {
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .meal-plan-day-header {
            background: #007bff;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meal-plan-day-content {
            padding: 15px;
        }

        .meal-type {
            margin-bottom: 15px;
        }

        .meal-type:last-child {
            margin-bottom: 0;
        }

        .meal-type-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
            text-transform: capitalize;
        }

        .meal-items-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .meal-item-badge {
            background: #e7f3ff;
            color: #004085;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            border: 1px solid #b3d7ff;
        }

        .meal-item-badge .item-id {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }

        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .users-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .user-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .user-card.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .user-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .user-id {
            font-size: 12px;
            color: #666;
            font-family: 'Courier New', monospace;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .user-phone {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .user-profile-summary {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dee2e6;
        }

        .user-profile-summary-item {
            margin: 4px 0;
        }

        .user-profile-detail {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        .user-profile-detail-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .user-profile-detail-value {
            font-size: 14px;
            color: #333;
        }

        .user-profile-detail-value.empty {
            color: #999;
            font-style: italic;
        }

        .users-list-empty {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Meal Generation Testing UI</h1>
            <div class="header-controls">
                <button class="btn-info" onclick="openUsersListModal()">ðŸ‘¥ View Users</button>
                <button class="btn-success" onclick="openUserCreationModal()">+ Add User</button>
                <div class="input-group">
                    <input type="text" id="userIdInput" placeholder="Enter User ID (UUID)">
                    <button class="btn-secondary" id="fetchPreferencesBtn">Fetch Preferences</button>
                    <button class="btn-secondary" id="loadDefaultPromptsBtn">Load Default Prompts</button>
                </div>
                <button class="btn-primary" onclick="testGenerate()">Test Generate</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="grid">
            <div class="card">
                <div class="card-body">
                    <div class="mt-3 space-y-2">
                        <div>
                            <label class="card-title" style="font-size: 16px; display: block; margin-bottom: 8px;">
                                System Prompt (Part 1 - Dynamic Rules)
                            </label>
                            <label class="card-subtitle" style="font-size: 14px; color: #666; display: block; margin-bottom: 15px;">
                                Customize the dynamic rules part. Leave empty to use default rules. Part 2 (meal items + output format) is always static.
                            </label>
                        </div>
                        <textarea 
                            id="systemPrompt" 
                            rows="14"
                            placeholder="Enter custom system prompt Part 1 (dynamic rules). Leave empty to use default. Note: Part 2 (meal items JSON + output format) is always static and cannot be customized."
                        >{{ system_prompt }}</textarea>
                    </div>
                </div>
                <div class="card-body" style="margin-top: 20px;">
                    <div class="mt-3 space-y-2">
                        <div>
                            <label class="card-title" style="font-size: 16px; display: block; margin-bottom: 8px;">
                                User Prompt Part 1 (Dynamic Instructions)
                            </label>
                            <label class="card-subtitle" style="font-size: 14px; color: #666; display: block; margin-bottom: 15px;">
                                Customize the dynamic instructions part. Leave empty to use default. Part 2 (user preferences) is always included automatically.
                            </label>
                        </div>
                        <textarea 
                            id="userPromptPart1" 
                            rows="14"
                            placeholder="Enter custom user prompt Part 1 (dynamic instructions). Leave empty to use default. Note: Part 2 (user preferences) is always static and cannot be customized."
                        >{{ user_prompt }}</textarea>
                    </div>
                </div>
                <div class="card-body" style="margin-top: 20px;">
                    <div class="mt-3 space-y-2">
                        <div>
                            <label class="card-title" style="font-size: 16px; display: block; margin-bottom: 8px;">
                                User Prompt Part 2 (User Preferences - Auto-generated)
                            </label>
                            <label class="card-subtitle" style="font-size: 14px; color: #666; display: block; margin-bottom: 15px;">
                                This part is automatically built from the selected user's preferences. It includes all user data: goals, dietary restrictions, meal preferences, etc. This part cannot be customized.
                            </label>
                            <button class="btn-secondary" onclick="toggleUserPromptPart2View()" style="margin-bottom: 10px;">
                                <span id="userPromptPart2ToggleText">Show User Preferences (Part 2)</span>
                            </button>
                        </div>
                        <textarea 
                            id="userPromptPart2" 
                            rows="14"
                            readonly
                            style="display: none; background: #f8f9fa; font-family: 'Courier New', monospace; font-size: 12px;"
                            placeholder="User preferences (Part 2) will appear here after fetching user preferences..."
                        ></textarea>
                    </div>
                </div>
                <div id="resultContainer" class="result-container">
                    <div class="result-header">
                        <h3 style="margin: 0;">Meal Plan Generation Result</h3>
                        <button class="btn-success" id="downloadCsvBtn" onclick="downloadMealPlanCSV()" style="display: none;">
                            ðŸ“¥ Download CSV
                        </button>
                    </div>
                    <div class="result-tabs">
                        <button class="result-tab active" onclick="switchResultView('structured', this)">Structured View</button>
                        <button class="result-tab" onclick="switchResultView('json', this)">JSON View</button>
                    </div>
                    <div id="structuredView" class="result-view active">
                        <div id="structuredContent" class="meal-plan-structured"></div>
                    </div>
                    <div id="jsonView" class="result-view">
                    <pre id="resultContent"></pre>
                    </div>
                </div>
            </div>

            <div class="preferences-card">
                <div class="preferences-header">
                    <h3>User Preferences</h3>
                </div>
                <div class="preferences-body" id="preferencesContainer">
                    <p style="color: #999; text-align: center; padding: 20px;">
                        Enter a User ID and click "Fetch Preferences" to load user data, or create a new user using "Add User"
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal-backdrop" id="loadingModal">
        <div class="modal-content">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Users List Modal -->
    <div class="modal-backdrop" id="usersListModal">
        <div class="modal-content modal-extra-large">
            <div class="modal-header">
                <h2>All Users</h2>
                <button class="close-btn" onclick="closeUsersListModal()">&times;</button>
            </div>
            <div id="usersListAlertContainer"></div>
            <div id="usersListContainer">
                <div class="users-list-empty">
                    <p>Click "Load Users" to fetch the list of users</p>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="closeUsersListModal()">Close</button>
                <button type="button" class="btn-primary" onclick="loadUsersList()">Load Users</button>
            </div>
        </div>
    </div>

    <!-- User Creation Modal -->
    <div class="modal-backdrop" id="userCreationModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Create Test User</h2>
                <button class="close-btn" onclick="closeUserCreationModal()">&times;</button>
            </div>
            <div id="userCreationAlertContainer"></div>
            <form id="userCreationForm">
                <div class="section-title">Basic Information</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fullName">Full Name <span class="required">*</span></label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" name="age" min="1" max="120">
                    </div>
                    <div class="form-group">
                        <label for="totalHouseholdAdults">Total Household Adults</label>
                        <input type="number" id="totalHouseholdAdults" name="totalHouseholdAdults" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label for="totalHouseholdChildren">Total Household Children</label>
                        <input type="number" id="totalHouseholdChildren" name="totalHouseholdChildren" min="0" value="0">
                    </div>
                </div>

                <div class="section-title">Goals & Restrictions</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="goals">Goals (Multi-select)</label>
                        <select id="goals" name="goals" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="medicalRestrictions">Medical Restrictions (Multi-select)</label>
                        <select id="medicalRestrictions" name="medicalRestrictions" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="dietaryPattern">Dietary Pattern</label>
                        <select id="dietaryPattern" name="dietaryPattern">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nutritionPreferences">Nutrition Preferences (Multi-select)</label>
                        <select id="nutritionPreferences" name="nutritionPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="dietaryRestrictions">Dietary Restrictions (Multi-select)</label>
                        <select id="dietaryRestrictions" name="dietaryRestrictions" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="cuisinesPreferences">Favorite Cuisines (Multi-select)</label>
                        <select id="cuisinesPreferences" name="cuisinesPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                </div>

                <div class="section-title">Meal Preferences</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="breakfastPreferences">Breakfast Preferences (Multi-select)</label>
                        <select id="breakfastPreferences" name="breakfastPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="lunchPreferences">Lunch Preferences (Multi-select)</label>
                        <select id="lunchPreferences" name="lunchPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="snacksPreferences">Snacks Preferences (Multi-select)</label>
                        <select id="snacksPreferences" name="snacksPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                    <div class="form-group">
                        <label for="dinnerPreferences">Dinner Preferences (Multi-select)</label>
                        <select id="dinnerPreferences" name="dinnerPreferences" multiple>
                            <option value="">Loading...</option>
                        </select>
                        <div class="help-text">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                </div>

                <div class="section-title">Additional Information</div>
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="extraInput">Other Instructions</label>
                        <textarea id="extraInput" name="extraInput" placeholder="Enter any additional preferences or instructions..." style="min-height: 100px;"></textarea>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn-secondary" onclick="resetUserForm()">Reset</button>
                    <button type="submit" class="btn-primary" id="submitUserBtn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const MEAL_GEN_API = '/test-meal-generation';
        const USER_CREATION_API = '/test/user-creation';
        let onboardingData = null;
        let usersList = [];
        let selectedUserId = null;

        document.addEventListener('DOMContentLoaded', function () {
            const fetchPreferencesBtn = document.getElementById('fetchPreferencesBtn');
            const userIdInput = document.getElementById('userIdInput');

            fetchPreferencesBtn.addEventListener('click', function () {
                const userId = userIdInput.value.trim();
                if (!userId) {
                    showAlert('Please enter a User ID', 'error');
                    return;
                }

                showLoading();
                fetch(`${MEAL_GEN_API}/fetch-preferences/${userId}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.detail || 'Failed to fetch preferences');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        hideLoading();
                        displayPreferences(data.preferences);
                        // Also load the full user prompt
                        loadUserPrompt(userId);
                    })
                    .catch(error => {
                        hideLoading();
                        console.error('Error fetching preferences:', error);
                        showAlert('Error fetching preferences: ' + error.message, 'error');
                    });
            });

            document.getElementById('userCreationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createUser();
            });

            // Add event listener to dietary pattern dropdown to update meal preferences
            document.getElementById('dietaryPattern').addEventListener('change', function() {
                updateMealPreferences();
            });

            // Load default prompts button
            document.getElementById('loadDefaultPromptsBtn').addEventListener('click', function() {
                loadDefaultPrompts();
            });
        });

        function openUserCreationModal() {
            document.getElementById('userCreationModal').classList.add('show');
            if (!onboardingData) {
                loadOnboardingData();
            }
        }

        function closeUserCreationModal() {
            document.getElementById('userCreationModal').classList.remove('show');
        }

        async function loadOnboardingData() {
            try {
                showLoading();
                const response = await fetch(`${USER_CREATION_API}/onboarding-data`);
                if (!response.ok) {
                    throw new Error('Failed to load onboarding data');
                }
                const result = await response.json();
                onboardingData = result.data;
                populateDropdowns();
                hideLoading();
            } catch (error) {
                hideLoading();
                showUserCreationAlert('Error loading onboarding data: ' + error.message, 'error');
                console.error('Error loading onboarding data:', error);
            }
        }

        function populateDropdowns() {
            if (!onboardingData) return;

            populateMultiSelect('goals', onboardingData.goals || []);
            populateMultiSelect('medicalRestrictions', onboardingData.medical_restrictions || []);
            populateSelect('dietaryPattern', onboardingData.dietary_patterns || []);
            populateMultiSelect('nutritionPreferences', onboardingData.nutrition_preferences || []);
            populateMultiSelect('dietaryRestrictions', onboardingData.dietary_restrictions || []);
            populateMultiSelect('cuisinesPreferences', onboardingData.cuisines || []);

            // Update meal preferences based on dietary pattern
            updateMealPreferences();
        }

        function updateMealPreferences() {
            if (!onboardingData) return;

            const mealItems = onboardingData.meal_items || [];
            const selectedDietaryPattern = document.getElementById('dietaryPattern').value.toLowerCase();
            
            // Map items to the correct field names
            const mapMealItem = (item) => {
                return {
                    id: item.onboarding_meal_item_id || item.id || item.meal_item_id || '',
                    name: item.onboarding_meal_item_name || item.name || item.meal_item_name || ''
                };
            };
            
            // Determine which dietary pattern flag to check
            let dietaryPatternFlag = null;
            let dietaryPatternFlagAlt = null;
            if (selectedDietaryPattern.includes('vegetarian') || selectedDietaryPattern.includes('veg')) {
                // Check for is_vegetarian or can_vegetarian_eat
                dietaryPatternFlag = 'is_vegetarian';
                dietaryPatternFlagAlt = 'can_vegetarian_eat';
            } else if (selectedDietaryPattern.includes('eggetarian') || selectedDietaryPattern.includes('egg')) {
                dietaryPatternFlag = 'is_eggetarian';
                dietaryPatternFlagAlt = 'can_eggetarian_eat';
            } else if (selectedDietaryPattern.includes('vegan')) {
                dietaryPatternFlag = 'is_vegan';
                dietaryPatternFlagAlt = 'can_vegan_eat';
            } else if (selectedDietaryPattern.includes('carnitarian') || selectedDietaryPattern.includes('non-veg') || selectedDietaryPattern.includes('nonveg')) {
                dietaryPatternFlag = 'is_carnitarian';
                dietaryPatternFlagAlt = 'can_carnitarian_eat';
            } else if (selectedDietaryPattern.includes('omnitarian') || selectedDietaryPattern.includes('omnivore')) {
                dietaryPatternFlag = 'is_omnitarian';
                dietaryPatternFlagAlt = 'can_omnitarian_eat';
            }
            
            // Filter meal items by meal type AND dietary pattern
            let breakfastItems = [];
            let lunchItems = [];
            let snacksItems = [];
            let dinnerItems = [];
            
            mealItems.forEach(item => {
                // Check dietary pattern compatibility
                let isCompatible = true;
                if (dietaryPatternFlag) {
                    // Try both is_* and can_* field names
                    const isCompatible1 = item[dietaryPatternFlag] === true || item[dietaryPatternFlag] === 'true' || item[dietaryPatternFlag] === 1;
                    const isCompatible2 = dietaryPatternFlagAlt ? (item[dietaryPatternFlagAlt] === true || item[dietaryPatternFlagAlt] === 'true' || item[dietaryPatternFlagAlt] === 1) : false;
                    isCompatible = isCompatible1 || isCompatible2;
                }
                
                if (!isCompatible) return; // Skip items not compatible with dietary pattern
                
                // Try different field names for meal type
                const mealType = (item.meal_type_name || item.meal_type || item.type || '').toString().toLowerCase();
                
                // Also check for boolean flags
                const isBreakfast = item.is_breakfast === true || item.is_breakfast === 'true' || item.is_breakfast === 1 || mealType.includes('breakfast');
                const isLunch = item.is_lunch === true || item.is_lunch === 'true' || item.is_lunch === 1 || mealType.includes('lunch');
                const isSnacks = item.is_snacks === true || item.is_snacks === 'true' || item.is_snacks === 1 || item.is_snack === true || mealType.includes('snack');
                const isDinner = item.is_dinner === true || item.is_dinner === 'true' || item.is_dinner === 1 || mealType.includes('dinner');
                
                const mappedItem = mapMealItem(item);
                
                if (isBreakfast && mappedItem.name) breakfastItems.push(mappedItem);
                if (isLunch && mappedItem.name) lunchItems.push(mappedItem);
                if (isSnacks && mappedItem.name) snacksItems.push(mappedItem);
                if (isDinner && mappedItem.name) dinnerItems.push(mappedItem);
            });
            
            // If no items found with filtering, show all items as fallback (only if no dietary pattern selected)
            if (breakfastItems.length === 0 && lunchItems.length === 0 && snacksItems.length === 0 && dinnerItems.length === 0 && mealItems.length > 0) {
                if (!selectedDietaryPattern) {
                    console.warn('No meal items found with filtering. Showing all items in all dropdowns.');
                    const allItems = mealItems.map(mapMealItem).filter(item => item.name);
                    populateMultiSelect('breakfastPreferences', allItems);
                    populateMultiSelect('lunchPreferences', allItems);
                    populateMultiSelect('snacksPreferences', allItems);
                    populateMultiSelect('dinnerPreferences', allItems);
                } else {
                    // Dietary pattern selected but no compatible items found
                    populateMultiSelect('breakfastPreferences', []);
                    populateMultiSelect('lunchPreferences', []);
                    populateMultiSelect('snacksPreferences', []);
                    populateMultiSelect('dinnerPreferences', []);
                }
            } else {
                populateMultiSelect('breakfastPreferences', breakfastItems);
                populateMultiSelect('lunchPreferences', lunchItems);
                populateMultiSelect('snacksPreferences', snacksItems);
                populateMultiSelect('dinnerPreferences', dinnerItems);
            }
            
            // Debug: Log counts
            console.log('Meal items counts (after dietary pattern filter):', {
                dietaryPattern: selectedDietaryPattern,
                total: mealItems.length,
                breakfast: breakfastItems.length,
                lunch: lunchItems.length,
                snacks: snacksItems.length,
                dinner: dinnerItems.length
            });
        }

        function populateSelect(selectId, items) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select...</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name || item;
                option.textContent = item.name || item;
                select.appendChild(option);
            });
        }

        function populateMultiSelect(selectId, items) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            if (!items || items.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No items available';
                option.disabled = true;
                select.appendChild(option);
                return;
            }
            
            items.forEach(item => {
                const option = document.createElement('option');
                const value = item.name || item.value || item;
                const text = item.name || item.value || item;
                option.value = value;
                option.textContent = text;
                select.appendChild(option);
            });
        }

        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        async function createUser() {
            const formData = {
                full_name: document.getElementById('fullName').value.trim(),
                age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null,
                total_household_adults: parseInt(document.getElementById('totalHouseholdAdults').value) || 1,
                total_household_children: parseInt(document.getElementById('totalHouseholdChildren').value) || 0,
                goals: getSelectedValues('goals'),
                medical_restrictions: getSelectedValues('medicalRestrictions'),
                dietary_pattern: document.getElementById('dietaryPattern').value || null,
                nutrition_preferences: getSelectedValues('nutritionPreferences'),
                dietary_restrictions: getSelectedValues('dietaryRestrictions'),
                cuisines_preferences: getSelectedValues('cuisinesPreferences'),
                breakfast_preferences: getSelectedValues('breakfastPreferences'),
                lunch_preferences: getSelectedValues('lunchPreferences'),
                snacks_preferences: getSelectedValues('snacksPreferences'),
                dinner_preferences: getSelectedValues('dinnerPreferences'),
                extra_input: document.getElementById('extraInput').value.trim() || null
            };

            if (!formData.full_name) {
                showUserCreationAlert('Please enter a full name', 'error');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${USER_CREATION_API}/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to create user');
                }

                hideLoading();
                showUserCreationAlert('User created successfully!', 'success');
                
                // Auto-populate User ID and fetch preferences
                document.getElementById('userIdInput').value = result.data.user_id;
                closeUserCreationModal();
                
                // Auto-fetch preferences
                setTimeout(() => {
                    document.getElementById('fetchPreferencesBtn').click();
                }, 500);
                
                resetUserForm();
            } catch (error) {
                hideLoading();
                showUserCreationAlert('Error creating user: ' + error.message, 'error');
                console.error('Error creating user:', error);
            }
        }

        function resetUserForm() {
            document.getElementById('userCreationForm').reset();
            document.getElementById('totalHouseholdAdults').value = '1';
            document.getElementById('totalHouseholdChildren').value = '0';
        }

        function displayPreferences(preferences) {
            const container = document.getElementById('preferencesContainer');
            container.innerHTML = '';

            const preferenceFields = [
                { key: 'age', label: 'Age' },
                { key: 'gender', label: 'Gender' },
                { key: 'goals', label: 'Goals' },
                { key: 'medical_restrictions', label: 'Medical Restrictions' },
                { key: 'dietary_restrictions', label: 'Dietary Restrictions' },
                { key: 'dietary_pattern', label: 'Dietary Pattern' },
                { key: 'nutrition_preferences', label: 'Nutrition Preferences' },
                { key: 'spice_level', label: 'Spice Level' },
                { key: 'cuisines_preferences', label: 'Favorite Cuisines' },
                { key: 'breakfast_preferences', label: 'Breakfast Preferences' },
                { key: 'lunch_preferences', label: 'Lunch Preferences' },
                { key: 'snacks_preferences', label: 'Snacks Preferences' },
                { key: 'dinner_preferences', label: 'Dinner Preferences' },
                { key: 'total_household_adults', label: 'Household Adults' },
                { key: 'total_household_children', label: 'Household Children' },
                { key: 'extra_input', label: 'Additional Notes' }
            ];

            preferenceFields.forEach(field => {
                const value = preferences[field.key];
                const displayValue = Array.isArray(value) 
                    ? (value.length > 0 ? value.join(', ') : 'None')
                    : (value || 'Not specified');

                const item = document.createElement('div');
                item.className = 'preference-item';
                item.innerHTML = `
                    <div class="preference-label">${field.label}</div>
                    <div class="preference-value ${!value || (Array.isArray(value) && value.length === 0) ? 'empty' : ''}">
                        ${displayValue}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function testGenerate() {
            const userId = document.getElementById('userIdInput').value.trim();
            const systemPromptPart = document.getElementById('systemPrompt').value.trim();
            const userPromptPart1 = document.getElementById('userPromptPart1').value.trim();

            if (!userId) {
                showAlert('Please enter a User ID', 'error');
                return;
            }

            showLoading();

            // Build request body - only include non-empty custom prompts
            const requestBody = {
                user_id: userId
            };
            
            // Only include system_prompt_part if provided (not empty)
            if (systemPromptPart) {
                requestBody.system_prompt_part = systemPromptPart;
            }
            
            // Only include user_prompt_part1 if provided (not empty)
            if (userPromptPart1) {
                requestBody.user_prompt_part1 = userPromptPart1;
            }

            fetch(`${MEAL_GEN_API}/test-generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.detail || 'Failed to generate meal plan');
                    });
                }
                return response.json();
            })
            .then(data => {
                hideLoading();
                displayResult(data);
            })
            .catch(error => {
                hideLoading();
                console.error('Error generating meal plan:', error);
                showAlert('Error generating meal plan: ' + error.message, 'error');
            });
        }

        let currentMealPlanData = null;

        function displayResult(data) {
            const container = document.getElementById('resultContainer');
            const jsonContent = document.getElementById('resultContent');
            const structuredContent = document.getElementById('structuredContent');
            const downloadBtn = document.getElementById('downloadCsvBtn');
            
            container.classList.add('show');
            currentMealPlanData = data;
            
            // Display JSON
            jsonContent.textContent = JSON.stringify(data, null, 2);
            
            // Display structured view
            displayStructuredMealPlan(data, structuredContent);
            
            // Show download button if meal plan exists
            if (data && data.data && data.data.meal_plan) {
                downloadBtn.style.display = 'block';
            } else {
                downloadBtn.style.display = 'none';
            }
        }

        function switchResultView(view, buttonElement) {
            // Update tabs
            document.querySelectorAll('.result-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Update views
            document.getElementById('structuredView').classList.remove('active');
            document.getElementById('jsonView').classList.remove('active');
            
            if (view === 'structured') {
                document.getElementById('structuredView').classList.add('active');
            } else {
                document.getElementById('jsonView').classList.add('active');
            }
        }

        function displayStructuredMealPlan(data, container) {
            container.innerHTML = '';
            
            if (!data || !data.data || !data.data.meal_plan) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No meal plan data available</p>';
                return;
            }
            
            const mealPlan = data.data.meal_plan;
            
            if (Array.isArray(mealPlan)) {
                mealPlan.forEach(day => {
                    const dayCard = document.createElement('div');
                    dayCard.className = 'meal-plan-day';
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'meal-plan-day-header';
                    dayHeader.innerHTML = `
                        <span>Day ${day.day || 'N/A'}</span>
                        <span style="font-size: 12px; font-weight: normal;">${day.date || 'N/A'}</span>
                    `;
                    
                    const dayContent = document.createElement('div');
                    dayContent.className = 'meal-plan-day-content';
                    
                    const meals = day.meals || {};
                    const mealTypes = ['breakfast', 'lunch', 'snacks', 'dinner'];
                    
                    mealTypes.forEach(mealType => {
                        if (meals[mealType] && Array.isArray(meals[mealType]) && meals[mealType].length > 0) {
                            const mealTypeDiv = document.createElement('div');
                            mealTypeDiv.className = 'meal-type';
                            
                            const mealTypeHeader = document.createElement('div');
                            mealTypeHeader.className = 'meal-type-header';
                            mealTypeHeader.textContent = mealType;
                            
                            const mealItemsList = document.createElement('div');
                            mealItemsList.className = 'meal-items-list';
                            
                            meals[mealType].forEach(item => {
                                const badge = document.createElement('div');
                                badge.className = 'meal-item-badge';
                                badge.innerHTML = `
                                    ${item.name || 'N/A'}
                                    <span class="item-id">(ID: ${item.id || 'N/A'})</span>
                                `;
                                mealItemsList.appendChild(badge);
                            });
                            
                            mealTypeDiv.appendChild(mealTypeHeader);
                            mealTypeDiv.appendChild(mealItemsList);
                            dayContent.appendChild(mealTypeDiv);
                        }
                    });
                    
                    dayCard.appendChild(dayHeader);
                    dayCard.appendChild(dayContent);
                    container.appendChild(dayCard);
                });
            } else {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">Invalid meal plan format</p>';
            }
        }

        function downloadMealPlanCSV() {
            if (!currentMealPlanData || !currentMealPlanData.data || !currentMealPlanData.data.meal_plan) {
                showAlert('No meal plan data available to download', 'error');
                return;
            }
            
            const mealPlan = currentMealPlanData.data.meal_plan;
            const userId = currentMealPlanData.data.user_id || 'unknown';
            
            // Build CSV content
            let csvContent = 'Day,Date,Meal Type,Meal Item ID,Meal Item Name\n';
            
            if (Array.isArray(mealPlan)) {
                mealPlan.forEach(day => {
                    const dayNum = day.day || '';
                    const date = day.date || '';
                    const meals = day.meals || {};
                    
                    const mealTypes = ['breakfast', 'lunch', 'snacks', 'dinner'];
                    mealTypes.forEach(mealType => {
                        if (meals[mealType] && Array.isArray(meals[mealType])) {
                            meals[mealType].forEach(item => {
                                const itemId = item.id || '';
                                const itemName = (item.name || '').replace(/"/g, '""'); // Escape quotes
                                csvContent += `${dayNum},"${date}","${mealType}","${itemId}","${itemName}"\n`;
                            });
                        }
                    });
                });
            }
            
            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `meal_plan_${userId}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Meal plan downloaded as CSV', 'success');
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showUserCreationAlert(message, type) {
            const container = document.getElementById('userCreationAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingModal').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.remove('show');
        }

        // Close modal when clicking outside
        document.getElementById('userCreationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserCreationModal();
            }
        });

        document.getElementById('usersListModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUsersListModal();
            }
        });

        function openUsersListModal() {
            document.getElementById('usersListModal').classList.add('show');
            // Auto-load users when modal opens
            loadUsersList();
        }

        function closeUsersListModal() {
            document.getElementById('usersListModal').classList.remove('show');
        }

        async function loadUsersList() {
            try {
                showLoading();
                const response = await fetch(`${MEAL_GEN_API}/list-users?limit=100`);
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                const result = await response.json();
                usersList = result.data || [];
                hideLoading();
                displayUsersList(usersList);
            } catch (error) {
                hideLoading();
                showUsersListAlert('Error loading users: ' + error.message, 'error');
                console.error('Error loading users:', error);
            }
        }

        function displayUsersList(users) {
            const container = document.getElementById('usersListContainer');
            container.innerHTML = '';

            if (!users || users.length === 0) {
                container.innerHTML = '<div class="users-list-empty"><p>No users found</p></div>';
                return;
            }

            const usersGrid = document.createElement('div');
            usersGrid.className = 'users-list';

            users.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                if (selectedUserId === user.id) {
                    userCard.classList.add('selected');
                }

                const profile = user.profile || {};
                const isOnboardingComplete = profile.onboarding_completed || false;

                userCard.innerHTML = `
                    <div class="user-name">${user.full_name || 'No Name'}</div>
                    <div class="user-id">ID: ${user.id}</div>
                    <div class="user-phone">${user.phone_number || 'N/A'}</div>
                    <div class="user-profile-summary">
                        <div class="user-profile-summary-item">
                            <strong>Age:</strong> ${profile.age || 'N/A'} | 
                            <strong>Gender:</strong> ${profile.gender || 'N/A'}
                        </div>
                        <div class="user-profile-summary-item">
                            <strong>Dietary Pattern:</strong> ${profile.dietary_pattern || 'Not set'}
                        </div>
                        <div class="user-profile-summary-item">
                            <strong>Onboarding:</strong> ${isOnboardingComplete ? 'âœ“ Complete' : 'âœ— Incomplete'}
                        </div>
                        <div class="user-profile-summary-item">
                            <strong>Created:</strong> ${new Date(user.created_at).toLocaleDateString()}
                        </div>
                    </div>
                `;

                userCard.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('.user-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    // Add selection to clicked card
                    userCard.classList.add('selected');
                    selectedUserId = user.id;
                    
                    // Auto-populate User ID and fetch preferences
                    document.getElementById('userIdInput').value = user.id;
                    closeUsersListModal();
                    
                    // Auto-fetch preferences
                    setTimeout(() => {
                        document.getElementById('fetchPreferencesBtn').click();
                    }, 300);
                });

                usersGrid.appendChild(userCard);
            });

            container.appendChild(usersGrid);
        }

        function showUsersListAlert(message, type) {
            const container = document.getElementById('usersListAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        async function loadUserPrompt(userId) {
            try {
                const response = await fetch(`${MEAL_GEN_API}/get-default-prompts/${userId}`);
                if (!response.ok) {
                    throw new Error('Failed to load user prompt');
                }
                const result = await response.json();
                
                // Populate Part 2 (user preferences - read-only)
                if (result.data && result.data.user_prompt_full) {
                    // Extract Part 2 from full prompt (everything after "USER PROFILE:")
                    const fullPrompt = result.data.user_prompt_full;
                    const part2Start = fullPrompt.indexOf('USER PROFILE:');
                    if (part2Start !== -1) {
                        const part2 = fullPrompt.substring(part2Start);
                        document.getElementById('userPromptPart2').value = part2;
                    } else {
                        document.getElementById('userPromptPart2').value = fullPrompt;
                    }
                }
            } catch (error) {
                console.error('Error loading user prompt:', error);
                // Don't show alert for this, it's not critical
            }
        }

        function toggleUserPromptPart2View() {
            const promptTextarea = document.getElementById('userPromptPart2');
            const toggleText = document.getElementById('userPromptPart2ToggleText');
            
            if (promptTextarea.style.display === 'none') {
                promptTextarea.style.display = 'block';
                toggleText.textContent = 'Hide User Preferences (Part 2)';
            } else {
                promptTextarea.style.display = 'none';
                toggleText.textContent = 'Show User Preferences (Part 2)';
            }
        }

        async function loadDefaultPrompts() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                showAlert('Please enter a User ID first', 'error');
                return;
            }

            try {
                showLoading();
                const response = await fetch(`${MEAL_GEN_API}/get-default-prompts/${userId}`);
                if (!response.ok) {
                    throw new Error('Failed to load default prompts');
                }
                const result = await response.json();
                hideLoading();
                
                // Populate the textareas with default prompts
                if (result.data) {
                    document.getElementById('systemPrompt').value = result.data.system_prompt_part1 || '';
                    document.getElementById('userPromptPart1').value = result.data.user_prompt_part1 || '';
                    
                    // Load Part 2 (user preferences)
                    if (result.data.user_prompt_full) {
                        const fullPrompt = result.data.user_prompt_full;
                        const part2Start = fullPrompt.indexOf('USER PROFILE:');
                        if (part2Start !== -1) {
                            const part2 = fullPrompt.substring(part2Start);
                            document.getElementById('userPromptPart2').value = part2;
                        }
                    }
                    
                    showAlert('Default prompts (Part 1) loaded. User preferences (Part 2) are shown below.', 'success');
                }
            } catch (error) {
                hideLoading();
                showAlert('Error loading default prompts: ' + error.message, 'error');
                console.error('Error loading default prompts:', error);
            }
        }
    </script>
</body>
</html>
